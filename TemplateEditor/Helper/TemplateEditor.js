define(["angular"],function(a){return a.module("Cerberus.Tool.TemplateEditor.Helper.TemplateEditor",[]).service("Cerberus.Tool.TemplateEditor.Helper.TemplateEditor",[function(){function b(a){for(var b=[],c="",d="",e="",f=0,h=g.length;h>f;f++)c=g[f],d=c.replace(/-([A-Z])/gi,function(a){return a[1].toUpperCase()}),e=a[d],""!==e&&b.push(String.format("{0}:{1}",c,e));return b.join(";")}function c(a){var b=a.get(0).style,c=b.right.length>0,d=b.bottom.length>0,e=c?"right":"left",f=d?"bottom":"top",g=!isNaN(parseInt(b.width))&&b.width.indexOf("%")>=0,h=!isNaN(parseInt(b.height))&&b.height.indexOf("%")>=0,i=!isNaN(parseInt(b[e]))&&b[e].indexOf("%")>=0,j=!isNaN(parseInt(b[f]))&&b[f].indexOf("%")>=0;a.attr({IsTransposedHorizontal:c,IsTransposedVertical:d,UnitHorizontal:i,UnitVertical:j,UnitWidth:g,UnitHeight:h})}function d(a){var b=a.get(0),c=a.parent(),d=c.width(),e=c.height(),f=0,g=0,h="true"==a.attr("IsTransposedVertical"),i="true"==a.attr("IsTransposedHorizontal"),j="true"==a.attr("UnitHorizontal"),k="true"==a.attr("UnitVertical"),l=tryParseInt(a.outerWidth()),m=tryParseInt(a.outerHeight());if(j)f=tryParseInt(a.css("left")),a.css("left",String.format("{0}%",(100*f/d).toFixed(1))),i&&(b.style.right=String.format("{0}%",(100-100*(f/d+l/d)).toFixed(1)));else{var n=tryParseInt(b.style.left);b.style.left=n+"px",i&&(b.style.right=d-n-l+"px")}if(k)g=tryParseInt(a.css("top")),a.css("top",String.format("{0}%",(100*g/e).toFixed(1))),h&&(b.style.bottom=String.format("{0}%",(100-100*(g/e+m/e)).toFixed(1)));else{var n=tryParseInt(b.style.top);b.style.top=n+"px",h&&(b.style.bottom=e-n-m+"px")}}function e(a){var b=(a.get(0),a.parent()),c=b.width(),d=b.height(),e=0,f=0,g="true"==a.attr("UnitWidth"),h="true"==a.attr("UnitHeight");g&&(e=tryParseInt(a.css("width")),a.css("width",String.format("{0}%",(100*e/c).toFixed(1)))),h&&(f=tryParseInt(a.css("height")),a.css("height",String.format("{0}%",(100*f/d).toFixed(1))))}var f=this,g=["display","left","right","top","bottom","width","height","opacity","font-family","font-size","font-style","font-weight","text-decoration","color","min-height","min-width","transform","overflow","-webkit-transform","word-spacing","text-align","padding-top","padding-right","padding-bottom","padding-left","border-top-style","border-top-width","border-top-color","border-right-style","border-right-width","border-right-color","border-bottom-style","border-bottom-width","border-bottom-color","border-left-style","border-left-width","border-left-color","border-top-left-radius","border-top-right-radius","border-bottom-right-radius","border-bottom-left-radius","background-color","background-image","background-repeat","background-size","background-position-x","background-position-y","text-shadow","box-shadow","white-space","z-index"];this.UpdateVisualProperties=function(a,c){var d=c.scope(),e=c.get(0),f=e.style.removeProperty?e.style.removeProperty:e.style.removeAttribute;f.call(e.style,"position"),d.TemplateControl.VisualProperties=b(c.get(0).style),d.$emit(a,d.TemplateControl),d.$apply()},this.EnableDraggable=function(a,b){var e=this,f={};b.draggable({snap:!0,snapTolerance:10,start:function(a){var b=$(this),d=$(".template-control.selected"),e=b.hasClass("selected");return b.draggable("option","snap",a.ctrlKey),e&&d.each(function(){var a=$(this);c(a),f[this.id]={StartPosition:a.position()}}).addClass("ui-draggable-dragging"),e},drag:function(a,b){var c=$(this),g=$(".template-control.selected");c.draggable("option","snap",a.ctrlKey);var h=b.originalPosition.left-b.position.left,i=b.originalPosition.top-b.position.top;g.each(function(){var a=$(this);elementData=f[this.id],a.css({left:elementData.StartPosition.left-h,top:elementData.StartPosition.top-i}),d(a),e.UpdateVisualProperties("TemplateControlUpdating",a)})},stop:function(a,b){var c=($(this),$(".template-control.selected")),g=b.originalPosition.left-b.position.left,h=b.originalPosition.top-b.position.top;c.each(function(){var a=$(this),b=a.get(0);elementData=f[this.id],a.css({left:elementData.StartPosition.left-g,top:elementData.StartPosition.top-h}),d(a);var c=b.style.removeProperty?b.style.removeProperty:b.style.removeAttribute,i="true"==a.attr("IsTransposedHorizontal"),j="true"==a.attr("IsTransposedVertical");i&&c.call(b.style,"left"),j&&c.call(b.style,"top"),a.removeAttr("IsTransposedHorizontal").removeAttr("IsTransposedVertical").removeAttr("UnitWidth").removeAttr("UnitHeight").removeAttr("UnitHorizontal").removeAttr("UnitVertical"),e.UpdateVisualProperties("TemplateControlUpdated",a)}).removeClass("ui-draggable-dragging")}})},this.EnableResizable=function(a,b){var d=this;b.resizable({start:function(){var a=$(this);c(a)},resize:function(){var a=$(this);e(a),d.UpdateVisualProperties("TemplateControlUpdating",a)},stop:function(){{var a=$(this);a.get(0)}e(a),a.removeAttr("IsTransposedHorizontal").removeAttr("IsTransposedVertical").removeAttr("UnitWidth").removeAttr("UnitHeight").removeAttr("UnitHorizontal").removeAttr("UnitVertical"),d.UpdateVisualProperties("TemplateControlUpdated",a)}})},this.EnableSelectable=function(b,c){var d=c.parent();c.unbind("click").click(function(c){var e=$(this),f=e.scope();if(e.data("Name",f.TemplateControl.ControlName),e.hasClass("selected")&&!c.ctrlKey)return!1;e.toggleClass("selected"),c.ctrlKey||e.siblings(".selected").removeClass("selected");var g=[],h=d.children(".template-control.selected");h.each(function(){g.push(a.element(this).scope().TemplateControl)}),b.$emit("TemplateControlSelected",g),b.$digest(),c.stopPropagation()})},this.EnableDrop=function(a,b){b.droppable({accept:".control-plugin",drop:function(b,c){var d=c.draggable.data("control-info"),e=$(this),f=c.offset.left-e.offset().left+d.CursorAt.left,g=c.offset.top-e.offset().top+d.CursorAt.top;a.$emit("AddTemplateControl",{ControlInfo:d,VisualProperties:String.format("left:{0}px;top:{1}px;",~~f,~~g)}),a.$digest()}})},this.FindResolution=function(a,b){var c=this.FindResolutionIndex(a,b);return c>=0?a.Resolutions[c]:null},this.FindResolutionIndex=function(a,b){for(var c=-1,d=0;d<a.Resolutions.length;d++){var e=a.Resolutions[d];if(e.ResolutionValue>=b){c=d;break}}return c},this.GetTemplateControlVisualProperties=function(a,b){for(var c=0;c<b.length;c++)if(b[c].Key==a)return b[c].Value;return""},this.RemapTemplateControlVisualProperties=function(a,b){for(var c=0;c<a.TemplateControls.length;c++){var d=a.TemplateControls[c];d.VisualProperties=this.GetTemplateControlVisualProperties(d.Id,b.TemplateControlVisualProperties)}},this.SetTemplateControlVisualProperties=function(a,b,c){for(var d=0;d<b.TemplateControlVisualProperties.length;d++){var e=b.TemplateControlVisualProperties[d];if(e.Key==c.Id)return void(b.TemplateControlVisualProperties[d].Value=c.VisualProperties)}for(var d=0;d<a.Resolutions.length;d++)a.Resolutions[d].TemplateControlVisualProperties.push({Key:c.Id,Value:c.VisualProperties})},this.OnTemplateControlUpdate=function(a,b){a.DataBagService.GetData("Template").then(function(c){var d=f.FindResolution(c,a.SliderValue);f.SetTemplateControlVisualProperties(c,d,b)})},this.RemoveTemplateControlFromResolutions=function(a,b){for(var c=0;c<a.Resolutions.length;c++){var d=a.Resolutions[c];d.TemplateControlVisualProperties.RemoveValue("Key",b.Id)}}}])});